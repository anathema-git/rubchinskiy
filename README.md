# Система справедливого дележа

Веб-система для решения задач справедливого дележа с делимыми и неделимыми пунктами.

## Описание

Система реализует алгоритм справедливого дележа между двумя участниками (A и B) на основе работы:
**Rubchinsky A. "Fair Division with Divisible and Indivisible Items" (2009)**

Алгоритм позволяет найти **пропорциональный делёж**, при котором каждый участник получает не менее половины от своей оценки всех предметов.

## Основные возможности

- ✅ Построение ломаной R для делимых пунктов
- ✅ Генерация множества S всех распределений неделимых пунктов (до 2^20 комбинаций)
- ✅ Выделение Парето-множества SP
- ✅ Проверка пропорциональности через вершины и геометрические методы
- ✅ Веб-интерфейс для ввода данных и визуализации результатов
- ✅ REST API для интеграции

## Архитектура

```
rubchinskiy/
├── app/                        # FastAPI приложение
│   ├── main.py                # Главный модуль
│   ├── api/                   # API endpoints
│   │   └── endpoints.py
│   ├── models/                # Pydantic модели
│   │   ├── request_models.py
│   │   └── response_models.py
│   ├── core/                  # Конфигурация
│   │   └── config.py
│   └── templates/             # HTML шаблоны
│       └── index.html
│
├── fair_division_engine/      # Математический движок
│   ├── r_polygon.py          # Построение ломаной R
│   ├── indivisible.py        # Множество S
│   ├── pareto.py             # Парето-фильтрация
│   ├── proportional.py       # Проверка пропорциональности
│   └── utils.py              # Утилиты
│
├── static/                    # Статические файлы
│   ├── styles.css
│   └── script.js
│
├── tests/                     # Тесты
│   ├── test_fair_division.py
│   └── test_api.py
│
├── requirements.txt           # Зависимости
└── README.md                  # Документация
```

## Установка

### 1. Клонирование репозитория

```bash
cd rubchinskiy
```

### 2. Создание виртуального окружения (рекомендуется)

```bash
python3.11 -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

## Запуск

### Запуск веб-сервера

```bash
python app/main.py
```

Или с использованием uvicorn:

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

Приложение будет доступно по адресу: **http://localhost:8000**

### Веб-интерфейс

Откройте браузер и перейдите по адресу: **http://localhost:8000**

### API документация

- Swagger UI: **http://localhost:8000/api/docs**
- ReDoc: **http://localhost:8000/api/redoc**

## Использование

### Веб-интерфейс

1. Укажите количество делимых пунктов (L) и неделимых пунктов (M)
2. Нажмите "Сгенерировать таблицы"
3. Заполните оценки участников A и B для каждого пункта
4. Нажмите "Решить"
5. Система выдаст результат:
   - Существует ли пропорциональный делёж
   - Распределение пунктов между участниками
   - Выигрыши участников A и B
   - Метод нахождения решения

### REST API

#### POST /api/solve

Решение задачи справедливого дележа.

**Запрос:**

```json
{
  "L": 3,
  "M": 4,
  "a_d": [10, 20, 30],
  "b_d": [15, 15, 20],
  "a_w": [35, 30, 15, 20],
  "b_w": [18, 20, 12, 25],
  "H": 100
}
```

**Ответ:**

```json
{
  "proportional_exists": true,
  "division": {
    "divisible_A": {"item_1": 1.0, "item_2": 1.0, "item_3": 0.0},
    "divisible_B": {"item_1": 0.0, "item_2": 0.0, "item_3": 1.0},
    "indivisible": [1, 0, 1, 0]
  },
  "gains": {
    "A": 56.67,
    "B": 56.67
  },
  "method": "vertex"
}
```

#### Пример с curl

```bash
curl -X POST "http://localhost:8000/api/solve" \
  -H "Content-Type: application/json" \
  -d '{
    "L": 3,
    "M": 4,
    "a_d": [10, 20, 30],
    "b_d": [15, 15, 20],
    "a_w": [35, 30, 15, 20],
    "b_w": [18, 20, 12, 25],
    "H": 100
  }'
```

## Тестирование

### Запуск всех тестов

```bash
pytest tests/ -v
```

### Запуск тестов алгоритмов

```bash
pytest tests/test_fair_division.py -v
```

### Запуск API тестов

```bash
pytest tests/test_api.py -v
```

## Алгоритм

Система реализует следующий алгоритм:

### 1. Построение ломаной R (Ad)

- Сортировка делимых пунктов по убыванию отношения a_i / b_i
- Построение ломаной от (0, Bd) до (Ad, 0)

### 2. Генерация множества S

- Перебор всех 2^M комбинаций распределения неделимых пунктов
- Для каждой комбинации вычисление выигрышей участников

### 3. Выделение Парето-множества SP

- Фильтрация Парето-оптимальных точек из S
- Точка (x, y) Парето-оптимальна, если нет другой точки (x', y'), где x' ≥ x и y' ≥ y

### 4. Проверка пропорциональности

Для каждой точки (x*, y*, σ) из SP:

1. Построение смещённой ломаной R* = R + (x*, y*)
2. **Проверка вершин:** если существует вершина (u_i, v_i) где u_i ≥ H/2 и v_i ≥ H/2
3. **Геометрическая проверка:** если отрезок R* пересекает линию x=H/2 при y≥H/2

## Математическая основа

### Условия пропорциональности (формулы 8a, 8b)

```
x* + u_i ≥ H/2
y* + v_i ≥ H/2
```

### Геометрическая проверка (формулы 10-11)

Уравнение прямой через две точки:
```
y = kx + b
k = (y2 - y1) / (x2 - x1)
b = y1 - k*x1
```

Подстановка x = H/2 и проверка Q = y ≥ H/2

## Ограничения

- **L ≤ 50** — максимальное количество делимых пунктов
- **M ≤ 20** — максимальное количество неделимых пунктов (2^20 ≈ 1 млн комбинаций)
- Суммы оценок участников должны быть равны H (обычно 100)

## Производительность

- Типичное время работы для L=10, M=10: **< 1 секунда**
- Для M=20: **< 5 секунд** (в зависимости от мощности CPU)

## Расширения

Система подготовлена для расширения:

- Поиск равноценных дележей
- Реализация алгоритмов profitably/uniformly/equitably fair divisions
- Поддержка более двух участников
- Визуализация ломаной R и Парето-множества

## Технологии

- **Python 3.11**
- **FastAPI** — веб-фреймворк
- **Pydantic** — валидация данных
- **Uvicorn** — ASGI сервер
- **Jinja2** — шаблонизация
- **pytest** — тестирование

## Автор

Реализация на основе алгоритма из работы:
**Rubchinsky A. "Fair Division with Divisible and Indivisible Items" (2009)**

## Лицензия

MIT License

## Контакты

Для вопросов и предложений создавайте issue в репозитории проекта.

---

**Fair Division System v1.0.0**
